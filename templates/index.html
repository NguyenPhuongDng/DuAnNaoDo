<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Giám Sát Giao Thông</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS tùy chỉnh */
        .roi-box {
            -webkit-user-select: none; /* Ngăn chọn text khi kéo */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Giữ cho video feed không bị kéo thả */
        #video-feed {
            pointer-events: none;
        }

        /* Đảm bảo container 800x600 giữ đúng tỷ lệ nhưng có thể co lại trên màn hình nhỏ */
        /* Tuy nhiên, logic JS hiện tại đang dựa trên 800x600 cố định */
        /* Chúng ta sẽ giữ 800x600 và cho phép cuộn ngang trên di động */
        #video-container {
            width: 800px;
            height: 600px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans p-4 sm:p-8">

    <div class="max-w-screen-xl mx-auto"> <!-- Container rộng hơn -->
        <h1 class="text-3xl font-bold text-center mb-6">Hệ Thống Giám Sát Giao Thông</h1>

        <!-- Wrapper cho nội dung chính (Video và Thống kê) -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- Cột 1: Video và ROIs -->
            <!-- Container này PHẢI là 800x600 vì logic JS (offsetLeft/Top) và
                 tọa độ zones.json được tính toán dựa trên kích thước cố định này -->
            <div class="mx-auto lg:mx-0 shrink-0">
                <div id="video-container" class="relative bg-black rounded-lg shadow-xl overflow-hidden">
                    
                    <!-- Video Stream từ Flask -->
                    <img id="video-feed" src="/video_feed" alt="Video Stream" class="w-full h-full">

                    <!-- Các vùng ROI (Regions of Interest) -->
                    
                    <div id="roi-North" class="roi-box absolute border-4 box-border cursor-move">
                        <span class="roi-label absolute top-0 left-1 px-2 py-0.5 text-sm font-bold text-white bg-black/50 rounded-br-lg">North</span>
                        <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 bg-white/70 border-2 border-black rounded-full cursor-se-resize -mr-1 -mb-1"></div>
                    </div>

                    <div id="roi-South" class="roi-box absolute border-4 box-border cursor-move">
                        <span class="roi-label absolute top-0 left-1 px-2 py-0.5 text-sm font-bold text-white bg-black/50 rounded-br-lg">South</span>
                        <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 bg-white/70 border-2 border-black rounded-full cursor-se-resize -mr-1 -mb-1"></div>
                    </div>

                    <div id="roi-East" class->="roi-box absolute border-4 box-border cursor-move">
                        <span class="roi-label absolute top-0 left-1 px-2 py-0.5 text-sm font-bold text-white bg-black/50 rounded-br-lg">East</span>
                        <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 bg-white/70 border-2 border-black rounded-full cursor-se-resize -mr-1 -mb-1"></div>
                    </div>

                    <div id="roi-West" class="roi-box absolute border-4 box-border cursor-move">
                        <span class="roi-label absolute top-0 left-1 px-2 py-0.5 text-sm font-bold text-white bg-black/50 rounded-br-lg">West</span>
                        <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 bg-white/70 border-2 border-black rounded-full cursor-se-resize -mr-1 -mb-1"></div>
                    </div>
                    
                    <!-- Bảng thống kê ĐÃ ĐƯỢC DI CHUYỂN ra ngoài -->

                </div>
                <p class="text-center text-gray-400 mt-4 max-w-[800px]">Kéo thả các góc để thay đổi kích thước, kéo thả vùng trung tâm để di chuyển.</p>
            </div>

            <!-- Cột 2: Bảng điều khiển và Thống kê -->
            <div id="stats-panel" class="w-full max-w-[800px] lg:max-w-none lg:w-auto lg:flex-1 bg-gray-800 p-6 rounded-lg shadow-lg mx-auto lg:mx-0">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">Thống Kê</h2>
                
                <div id="stats-list" class="space-y-4 text-lg">
                    
                    <!-- Các mục thống kê sẽ được cập nhật màu sắc bởi JS -->
                    <div id="stat-North" class="flex justify-between items-center font-bold p-3 rounded-md bg-gray-700/50">
                        <span class="mr-4">North:</span>
                        <span class="stat-count text-2xl">0</span>
                    </div>
                    
                    <div id="stat-South" class="flex justify-between items-center font-bold p-3 rounded-md bg-gray-700/50">
                        <span class="mr-4">South:</span>
                        <span class="stat-count text-2xl">0</span>
                    </div>
                    
                    <div id="stat-East" class="flex justify-between items-center font-bold p-3 rounded-md bg-gray-700/50">
                        <span class="mr-4">East:</span>
                        <span class="stat-count text-2xl">0</span>
                    </div>
                    
                    <div id="stat-West" class="flex justify-between items-center font-bold p-3 rounded-md bg-gray-700/50">
                        <span class="mr-4">West:</span>
                        <span class="stat-count text-2xl">0</span>
                    </div>
                    
                </div>
            </div> <!-- End of stats-panel -->

        </div> <!-- End of flex wrapper -->

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- Biến toàn cục ---
            let zones = {}; // Lưu trữ dữ liệu 4 zone
            let activeBox = null; // Box đang được tương tác
            let dragState = {
                action: null, // 'drag' hoặc 'resize'
                startX: 0,
                startY: 0,
                initialLeft: 0,
                initialTop: 0,
                initialWidth: 0,
                initialHeight: 0
            };
            const videoContainer = document.getElementById("video-container");

            // --- Hàm trợ giúp ---

            /**
             * Chuyển đổi mã hex sang rgba
             * @param {string} hex - Mã màu hex (e.g., "#FF0000")
             * @param {number} alpha - Độ trong suốt (0.0 đến 1.0)
             * @returns {string} - Chuỗi rgba
             */
            function hexToRgba(hex, alpha) {
                let r = 0, g = 0, b = 0;
                if (hex.length == 4) {
                    r = "0x" + hex[1] + hex[1];
                    g = "0x" + hex[2] + hex[2];
                    b = "0x" + hex[3] + hex[3];
                } else if (hex.length == 7) {
                    r = "0x" + hex[1] + hex[2];
                    g = "0x" + hex[3] + hex[4];
                    b = "0x" + hex[5] + hex[6];
                }
                return `rgba(${+r}, ${+g}, ${+b}, ${alpha})`;
            }

            // --- Cập nhật Giao diện (Render) ---

            /**
             * Cập nhật vị trí và màu sắc của các box trên DOM
             */
            function renderZones() {
                for (const [name, data] of Object.entries(zones)) {
                    const el = document.getElementById(`roi-${name}`);
                    const statEl = document.getElementById(`stat-${name}`);
                    
                    if (el) {
                        el.style.left = `${data.x}px`;
                        el.style.top = `${data.y}px`;
                        el.style.width = `${data.width}px`;
                        el.style.height = `${data.height}px`;
                        el.style.borderColor = data.color;
                        el.style.backgroundColor = hexToRgba(data.color, 0.2);
                    }
                    if (statEl) {
                        // Cập nhật màu chữ trên bảng thống kê
                        statEl.style.color = data.color;
                        // Bạn cũng có thể cập nhật viền nếu muốn
                        // statEl.style.borderColor = data.color;
                    }
                }
            }

            /**
             * Cập nhật số liệu thống kê xe
             * @param {object} stats - Đối tượng thống kê (e.g., {North: 5, South: 2})
             */
            function renderStats(stats) {
                for (const [name, count] of Object.entries(stats)) {
                    const el = document.getElementById(`stat-${name}`);
                    if (el) {
                        el.querySelector(".stat-count").textContent = count;
                    }
                }
            }

            // --- API Calls ---

            /**
             * Lấy dữ liệu zones ban đầu từ server
             */
            async function fetchZones() {
                try {
                    const response = await fetch('/get_zones');
                    if (!response.ok) throw new Error('Network error');
                    zones = await response.json();
                    renderZones();
                } catch (error) {
                    console.error("Lỗi khi tải zones:", error);
                }
            }

            /**
             * Gửi dữ liệu zones đã cập nhật lên server
             */
            async function saveZones() {
                const zonesToSave = {};
                for (const [name, data] of Object.entries(zones)) {
                    zonesToSave[name] = {
                        x: data.x,
                        y: data.y,
                        width: data.width,
                        height: data.height,
                        color: data.color
                    };
                }

                try {
                    await fetch('/update_zones', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(zonesToSave),
                    });
                } catch (error) {
                    console.error("Lỗi khi cập nhật zones:", error);
                }
            }

            /**
             * Lấy thống kê xe cộ theo thời gian thực
             */
            async function updateStats() {
                try {
                    const response = await fetch('/get_stats');
                    if (!response.ok) throw new Error('Network error');
                    const stats = await response.json();
                    renderStats(stats);
                } catch (error) {
                    console.error("Lỗi khi lấy thống kê:", error);
                }
            }

            // --- Xử lý Tương tác (Drag & Resize) ---

            /**
             * Khi nhấn chuột xuống một ROI
             * @param {MouseEvent} e - Sự kiện mousedown
             */
            function onMouseDown(e) {
                if (e.button !== 0) return;
                e.preventDefault();

                activeBox = e.currentTarget;
                
                dragState.startX = e.clientX;
                dragState.startY = e.clientY;
                dragState.initialLeft = activeBox.offsetLeft;
                dragState.initialTop = activeBox.offsetTop;
                dragState.initialWidth = activeBox.offsetWidth;
                dragState.initialHeight = activeBox.offsetHeight;

                if (e.target.classList.contains('resize-handle')) {
                    dragState.action = 'resize';
                    document.body.style.cursor = 'se-resize';
                } else {
                    dragState.action = 'drag';
                    document.body.style.cursor = 'move';
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            /**
             * Khi di chuyển chuột
             * @param {MouseEvent} e - Sự kiện mousemove
             */
            function onMouseMove(e) {
                if (!activeBox) return;
                e.preventDefault();

                const dx = e.clientX - dragState.startX;
                const dy = e.clientY - dragState.startY;

                // Kích thước của container (cố định 800x600)
                const containerWidth = videoContainer.offsetWidth;
                const containerHeight = videoContainer.offsetHeight;

                if (dragState.action === 'drag') {
                    let newLeft = dragState.initialLeft + dx;
                    let newTop = dragState.initialTop + dy;

                    // Giới hạn di chuyển trong container
                    newLeft = Math.max(0, Math.min(newLeft, containerWidth - activeBox.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, containerHeight - activeBox.offsetHeight));
                    
                    activeBox.style.left = `${newLeft}px`;
                    activeBox.style.top = `${newTop}px`;
                
                } else if (dragState.action === 'resize') {
                    let newWidth = dragState.initialWidth + dx;
                    let newHeight = dragState.initialHeight + dy;

                    // Giới hạn kích thước
                    newWidth = Math.max(20, newWidth);
                    newHeight = Math.max(20, newHeight);

                    // Đảm bảo không vượt ra ngoài container
                    if (dragState.initialLeft + newWidth > containerWidth) {
                        newWidth = containerWidth - dragState.initialLeft;
                    }
                    if (dragState.initialTop + newHeight > containerHeight) {
                        newHeight = containerHeight - dragState.initialTop;
                    }
                    
                    activeBox.style.width = `${newWidth}px`;
                    activeBox.style.height = `${newHeight}px`;
                }
            }

            /**
             * Khi nhả chuột
             * @param {MouseEvent} e - Sự kiện mouseup
             */
            function onMouseUp(e) {
                if (!activeBox) return;

                // Cập nhật đối tượng zones toàn cục
                const name = activeBox.id.split('-')[1]; // "North"
                if (zones[name]) {
                    zones[name].x = activeBox.offsetLeft;
                    zones[name].y = activeBox.offsetTop;
                    zones[name].width = activeBox.offsetWidth;
                    zones[name].height = activeBox.offsetHeight;
                    
                    // Gửi dữ liệu mới lên server
                    saveZones();
                }

                // Reset trạng thái
                activeBox = null;
                dragState.action = null;
                document.body.style.cursor = 'default';

                // Xóa listeners toàn cục
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }


            // --- Khởi tạo ---

            function initialize() {
                // Gắn listener mousedown cho tất cả các box
                document.querySelectorAll(".roi-box").forEach(box => {
                    box.addEventListener("mousedown", onMouseDown);
                });

                // Tải zones ban đầu
                fetchZones();

                // Bắt đầu cập nhật thống kê (mỗi 1.5 giây)
                setInterval(updateStats, 1500);
            }

            initialize();
        });
    </script>
</body>
</html>